#!/bin/sh
set -e

BIN_DIR=`dirname $0`
PROJECT_ROOT=`dirname $BIN_DIR`

# try plain postgres to start with
SUPABASE_DB_IMAGE=postgres:17-alpine
# SUPABASE_DB_IMAGE=public.ecr.aws/supabase/postgres:17.1.0.147

# start a shadow db to load up migrations as a comparison point
echo "Starting shadow supabase database\n"
SQITCH_TARGET=local-diff-shadow
SHADOW_CONTAINER=simt-supabasedb-$SQITCH_TARGET
docker run -d --name $SHADOW_CONTAINER \
            -p 54323:5432 \
            -e POSTGRES_PASSWORD=postgres \
            $SUPABASE_DB_IMAGE > /dev/null

# give postgres some time to start
sleep 5

# run migrations on shadow
echo "Apply migrations to shadow supabase database\n"
cd $PROJECT_ROOT/flows/sqitch
sqitch deploy $SQITCH_TARGET
cd - > /dev/null

echo "\nShadow db setup finished.\n"

# diff local with the shadow  
echo "\n================        diff        =================\n"
MIGRA_IMAGE=public.ecr.aws/supabase/migra:3.0.1663481299
set +e
docker run --rm -it --network host $MIGRA_IMAGE migra --unsafe \
    "postgresql://postgres:postgres@localhost:54323/postgres" \
    "postgresql://postgres:postgres@localhost:54322/postgres"
if [ "$?" = "0" ]; then
    echo "No changes\n"
fi

docker rm -f $SHADOW_CONTAINER > /dev/null
